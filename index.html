<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orgena Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Roboto',sans-serif;background:#f5f6fa;color:#333;}
header{background:#1abc9c;color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
header h1{font-weight:700;margin-bottom:5px;}
header nav{display:flex;flex-wrap:wrap;}
header nav button{margin:3px;padding:8px 15px;border:none;border-radius:5px;background:#16a085;color:white;font-weight:bold;cursor:pointer;transition:0.3s;}
header nav button:hover{background:#149174;}
main{max-width:1000px;margin:20px auto;padding:0 15px;}
#projects{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;}
.project{background:white;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);padding:15px;display:flex;flex-direction:column;transition:0.3s;}
.project:hover{transform:translateY(-3px);}
.project h3{margin-bottom:10px;color:#1abc9c;}
.code{background:#2c3e50;color:#ecf0f1;padding:10px;border-radius:8px;font-family:'Courier New',monospace;white-space:pre-wrap;overflow-x:auto;margin-bottom:10px;position:relative;}
.stars,.comments{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:5px;}
.star-btn{background:#e67e22;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-weight:bold;transition:0.2s;}
.star-btn.highlight{background:#f1c40f;}
.star-btn:hover{background:#cf711b;}
.comment-input{flex:1;padding:6px;border-radius:5px;border:1px solid #ccc;}
.comment-btn{padding:6px 12px;background:#2980b9;color:white;border:none;border-radius:5px;cursor:pointer;}
.comment-btn:hover{background:#1f5f8b;}
.delete-btn{padding:6px 12px;background:#c0392b;color:white;border:none;border-radius:5px;cursor:pointer;}
.delete-btn:hover{background:#992d22;}
.edit-btn{padding:6px 12px;background:#8e44ad;color:white;border:none;border-radius:5px;cursor:pointer;margin-left:5px;}
.edit-btn:hover{background:#732d91;}
#post-section, .profile-section{background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:20px;}
input,textarea{width:100%;margin-bottom:10px;padding:8px;border-radius:5px;border:1px solid #ccc;}
button{cursor:pointer;}
.comment{position:relative;background:#f0f0f0;padding:5px 10px;border-radius:5px;width:100%;display:flex;align-items:center;margin-bottom:3px;}
.comment p{margin:0;flex:1;display:flex;align-items:center;}
.comment p img{width:30px;height:30px;border-radius:50%;margin-right:8px;}
.expand-btn{margin-bottom:5px;align-self:flex-start;}
.profile-pic{width:40px;height:40px;border-radius:50%;vertical-align:middle;margin-right:10px;}
body.dark{background-color:#1e1e1e;color:#f5f5f5;}
body.dark header{background-color:#16a085;}
body.dark .project{background-color:#2c2c2c;color:#f5f5f5;}
body.dark .code{background-color:#333;color:#f5f5f5;}
body.dark .star-btn, body.dark .comment-btn, body.dark .delete-btn, body.dark .edit-btn{opacity:0.85;}
.code-copy-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  padding: 5px 10px;
  font-size: 12px;
  border-radius: 5px;
  border: none;
  background: rgba(255,255,255,0.9);
  cursor: pointer;
}
body.dark .code-copy-btn { background: rgba(0,0,0,0.6); color:#fff; }
.code-copy-btn.copied { background:#2ecc71 !important; color:#fff; }
@media(max-width:600px){.stars,.comments{flex-direction:column;align-items:stretch;}.comment-btn,.delete-btn,.edit-btn{width:100%;margin-top:5px;}}
</style>
</head>
<body>
<header>
<h1>Orgena Hub</h1>
<nav>
<button id="loginBtn">Login/Register</button>
<button id="logoutBtn" style="display:none;">Logout</button>
<button id="darkModeBtn">Toggle Dark Mode</button>
</nav>
</header>

<main>
<div id="post-section" style="display:none;">
<h2>Post Your Code</h2>
<input id="title" placeholder="Project Title">
<textarea id="code" rows="6" placeholder="Paste your code here"></textarea>
<button id="postBtn">Post Project</button>
</div>

<div class="profile-section" id="profile-section" style="display:none;">
<h2>Your Profile</h2>
<div id="profileName"></div>
<div id="userProjects"></div>
</div>

<h2>All Projects</h2>
<div id="projects"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4haY4VX-vgO03yA6Yj6hvsLw0EZav0Gk",
  authDomain: "orgenahub-7bca3.firebaseapp.com",
  projectId: "orgenahub-7bca3",
  storageBucket: "orgenahub-7bca3.appspot.com",
  messagingSenderId: "807048048445",
  appId: "1:807048048445:web:48a2e965eee533a40e5f54",
  measurementId: "G-ZZRELPEM6J"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const postSection = document.getElementById('post-section');
const titleInput = document.getElementById('title');
const codeInput = document.getElementById('code');
const postBtn = document.getElementById('postBtn');
const projectsContainer = document.getElementById('projects');
const profileSection = document.getElementById('profile-section');
const profileName = document.getElementById('profileName');
const userProjects = document.getElementById('userProjects');
const darkModeBtn = document.getElementById('darkModeBtn');
const defaultAvatar = 'https://www.w3schools.com/howto/img_avatar.png';

if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
darkModeBtn.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  localStorage.setItem('theme', document.body.classList.contains('dark')?'dark':'light');
});

let currentUser = null;

// --- Auth ---
loginBtn.addEventListener('click', async () => {
  try { const result = await signInWithPopup(auth, provider); currentUser = result.user; updateUI(); loadProjects(); }
  catch(e){alert("Login failed: "+e.message);}
});
logoutBtn.addEventListener('click', async ()=>{await signOut(auth); currentUser=null; updateUI();});
onAuthStateChanged(auth,user=>{currentUser=user; updateUI(); if(user) loadProjects();});

function updateUI(){
  loginBtn.style.display=currentUser?'none':'inline-block';
  logoutBtn.style.display=currentUser?'inline-block':'none';
  postSection.style.display=currentUser?'block':'none';
  profileSection.style.display=currentUser?'block':'none';
  if(currentUser){
    const avatar = currentUser.photoURL || defaultAvatar;
    profileName.innerHTML = `<img class="profile-pic" src="${avatar}"> ${currentUser.displayName}`;
  }
}

// --- Post project ---
postBtn.addEventListener('click', async () => {
  if(!currentUser) return alert("Login first");
  const title = titleInput.value.trim(), code = codeInput.value.trim();
  if(!title || !code) return alert("Fill both fields");
  await addDoc(collection(db,'projects'),{
    title, code,
    user: currentUser.displayName,
    userPhoto: currentUser.photoURL || defaultAvatar,
    stars: [],
    comments: [],
    createdAt: new Date()
  });
  titleInput.value=''; codeInput.value='';
});

// --- Star toggle ---
window.toggleStar = async id => {
  if(!currentUser) return alert("Login first");
  const ref = doc(db,'projects',id);
  const snap = await getDoc(ref);
  const stars = snap.data()?.stars || [];
  if(stars.includes(currentUser.displayName)) await updateDoc(ref,{stars: stars.filter(s=>s!==currentUser.displayName)});
  else await updateDoc(ref,{stars: arrayUnion(currentUser.displayName)});
};

// --- Add comment ---
window.addComment = async (id,inputElem)=>{
  if(!currentUser) return;
  const text = inputElem.value.trim(); if(!text) return;
  await updateDoc(doc(db,'projects',id),{
    comments: arrayUnion({
      id: Date.now(),
      user: currentUser.displayName,
      userPhoto: currentUser.photoURL || defaultAvatar,
      text
    })
  });
  inputElem.value=''; inputElem.focus();
};

// --- Delete comment ---
window.deleteComment = async (projectId, commentId)=>{
  if(!currentUser) return;
  const projSnap = await getDoc(doc(db,'projects',projectId));
  const comment = projSnap.data().comments.find(c=>c.id==commentId);
  if(!comment) return;
  if(comment.user!==currentUser.displayName && projSnap.data()?.user!==currentUser.displayName) return alert("Only comment owner or post owner can delete.");
  await updateDoc(doc(db,'projects',projectId),{comments: arrayRemove(comment)});
};

// --- Edit comment ---
window.editComment = async (projectId, commentId)=>{
  if(!currentUser) return;
  const projSnap = await getDoc(doc(db,'projects',projectId));
  const comment = projSnap.data().comments.find(c=>c.id==commentId);
  if(!comment || comment.user!==currentUser.displayName) return alert("Only comment owner can edit.");
  const newText = prompt("Edit your comment:", comment.text);
  if(!newText) return;
  await updateDoc(doc(db,'projects',projectId),{comments: arrayRemove(comment)});
  await updateDoc(doc(db,'projects',projectId),{comments: arrayUnion({...comment,text:newText})});
};

// --- Delete project ---
window.deleteProject = async (id,user)=>{if(!currentUser||currentUser.displayName!==user)return alert("Only owner can delete"); if(!confirm("Delete this project?")) return; await deleteDoc(doc(db,'projects',id));};

// --- Load projects ---
function loadProjects(){
  const q = query(collection(db,'projects'), orderBy('createdAt','desc'));
  onSnapshot(q,snapshot=>{
    projectsContainer.innerHTML=''; userProjects.innerHTML='';
    snapshot.forEach(docSnap=>{
      const p = docSnap.data();
      const div = document.createElement('div'); div.className="project";
      let codePreview=p.code; let isTruncated=false;
      if(p.code.length>130){codePreview=p.code.slice(0,130)+"..."; isTruncated=true;}
      div.innerHTML=`
        <h3>${p.title} by ${p.user}</h3>
        <pre class="code" id="code-${docSnap.id}" data-full-code="${p.code}">${codePreview}</pre>
        ${isTruncated?`<button class="expand-btn" data-id="${docSnap.id}">+ Expand</button>`:''}
        <div class="stars"><button class="star-btn ${p.stars?.includes(currentUser?.displayName)?'highlight':''}" data-id="${docSnap.id}">⭐ ${p.stars?.length||0}</button></div>
        <div class="comments" id="comments-${docSnap.id}">
          ${p.comments?.map(c=>`
            <div class="comment">
              <p><img src="${c.userPhoto || defaultAvatar}">${c.user}: ${c.text}</p>
              ${(currentUser && (c.user===currentUser.displayName || p.user===currentUser.displayName))?`
              <div class="comment-actions">
                ${c.user===currentUser.displayName?`<button class="edit-btn" data-id="${docSnap.id}" data-cid="${c.id}">Edit</button>`:''}
                <button class="delete-btn" data-id="${docSnap.id}" data-cid="${c.id}">Delete</button>
              </div>`:''}
            </div>`).join('')||''}
          ${currentUser?`<input class="comment-input" placeholder="Add comment" id="comment-input-${docSnap.id}">
          <button class="comment-btn" data-id="${docSnap.id}">Comment</button>`:''}
        </div>
        ${currentUser&&currentUser.displayName===p.user?`<button class="delete-btn" data-id="${docSnap.id}">Delete Post</button>`:''}
      `;
      projectsContainer.appendChild(div);
      // Add copy button
      const pre = div.querySelector('pre.code');
      const copyBtn = document.createElement('button');
      copyBtn.className='code-copy-btn';
      copyBtn.innerText='Copy';
      pre.appendChild(copyBtn);
      copyBtn.addEventListener('click', async ()=>{
        try {
          await navigator.clipboard.writeText(pre.dataset.fullCode);
          copyBtn.innerText='Copied!';
          copyBtn.classList.add('copied');
          setTimeout(()=>{copyBtn.innerText='Copy'; copyBtn.classList.remove('copied');},1200);
        } catch { copyBtn.innerText='Error'; setTimeout(()=>{copyBtn.innerText='Copy';},1200);}
      });
      if(currentUser && currentUser.displayName===p.user){
        const ud=document.createElement('div'); ud.className="project";
        ud.innerHTML=`<h4>${p.title}</h4><pre class="code" data-full-code="${p.code}">${p.code}</pre>
        <button class="delete-btn" data-id="${docSnap.id}">Delete Post</button>`;
        const preUD = ud.querySelector('pre.code');
        const copyBtnUD = document.createElement('button');
        copyBtnUD.className='code-copy-btn';
        copyBtnUD.innerText='Copy';
        preUD.appendChild(copyBtnUD);
        copyBtnUD.addEventListener('click', async ()=>{await navigator.clipboard.writeText(preUD.dataset.fullCode); copyBtnUD.innerText='Copied!'; setTimeout(()=>{copyBtnUD.innerText='Copy';},1200);});
        userProjects.appendChild(ud);
      }
    });
    // Expand button logic
    document.querySelectorAll('.expand-btn').forEach(btn=>{
      btn.onclick=()=>{
        const pre = document.getElementById('code-'+btn.dataset.id);
        pre.innerText = pre.dataset.fullCode;
        btn.style.display='none';
        // Re-add copy button if missing
        if(!pre.querySelector('.code-copy-btn')){
          const copyBtn = document.createElement('button');
          copyBtn.className='code-copy-btn';
          copyBtn.innerText='Copy';
          pre.appendChild(copyBtn);
          copyBtn.addEventListener('click', async ()=>{
            try { await navigator.clipboard.writeText(pre.dataset.fullCode); copyBtn.innerText='Copied!'; copyBtn.classList.add('copied'); setTimeout(()=>{copyBtn.innerText='Copy'; copyBtn.classList.remove('copied');},1200);}
            catch{copyBtn.innerText='Error'; setTimeout(()=>{copyBtn.innerText='Copy';},1200);}
          });
        }
      };
    });
    document.querySelectorAll('.star-btn').forEach(btn=>btn.onclick=()=>toggleStar(btn.dataset.id));
    document.querySelectorAll('.comment-btn').forEach(btn=>{const inputElem=document.getElementById('comment-input-'+btn.dataset.id); btn.onclick=()=>addComment(btn.dataset.id,inputElem);});
    document.querySelectorAll('.delete-btn').forEach(btn=>{
      if(btn.innerText==="Delete Post") btn.onclick=()=>deleteProject(btn.dataset.id,currentUser.displayName);
      else btn.onclick=()=>deleteComment(btn.dataset.id,parseInt(btn.dataset.cid));
    });
    document.querySelectorAll('.edit-btn').forEach(btn=>btn.onclick=()=>editComment(btn.dataset.id,parseInt(btn.dataset.cid)));
  });
}
</script>
</body>
</html>
