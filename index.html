<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orgena Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Roboto',sans-serif;background:#f5f6fa;color:#333;}
header{background:#1abc9c;color:white;padding:20px;display:flex;justify-content:space-between;align-items:center;}
header h1{font-weight:700;}
header nav button{margin-left:10px;padding:8px 15px;border:none;border-radius:5px;background:#16a085;color:white;font-weight:bold;cursor:pointer;transition:0.3s;}
header nav button:hover{background:#149174;}
main{max-width:1000px;margin:20px auto;padding:0 15px;}
#topProjects, #projects{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;}
.project{background:white;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);padding:15px;display:flex;flex-direction:column;transition:0.3s;}
.project:hover{transform:translateY(-3px);}
.project h3{margin-bottom:10px;color:#1abc9c;}
.code{background:#2c3e50;color:#ecf0f1;padding:10px;border-radius:8px;font-family:'Courier New',monospace;white-space:pre-wrap;overflow-x:auto;margin-bottom:10px;}
.stars,.comments{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:5px;}
.star-btn{background:#e67e22;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-weight:bold;transition:0.2s;}
.star-btn.highlight{background:#f1c40f;}
.star-btn:hover{background:#cf711b;}
.comment-input{flex:1;padding:6px;border-radius:5px;border:1px solid #ccc;}
.comment-btn{padding:6px 12px;background:#2980b9;color:white;border:none;border-radius:5px;cursor:pointer;}
.comment-btn:hover{background:#1f5f8b;}
.delete-btn{padding:6px 12px;background:#c0392b;color:white;border:none;border-radius:5px;cursor:pointer;}
.delete-btn:hover{background:#992d22;}
.expand-btn{padding:4px 10px;background:#2980b9;color:white;border:none;border-radius:5px;cursor:pointer;margin-bottom:10px;}
.expand-btn:hover{background:#1f5f8b;}
#post-section, .profile-section{background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:20px;}
input,textarea{width:100%;margin-bottom:10px;padding:8px;border-radius:5px;border:1px solid #ccc;}
button{cursor:pointer;}
@media(max-width:600px){.stars,.comments{flex-direction:column;align-items:stretch;}.comment-btn,.delete-btn,.expand-btn{width:100%;margin-top:5px;}}
</style>
</head>
<body>
<header>
<h1>Orgena Hub</h1>
<nav>
<button id="loginBtn">Login/Register</button>
<button id="logoutBtn" style="display:none;">Logout</button>
<button id="darkModeBtn">Toggle Dark Mode</button>
</nav>
<script>
// Dark mode toggle
const darkModeBtn = document.getElementById('darkModeBtn');
if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
darkModeBtn.addEventListener('click',()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light');
});
</script>
<style>
body.dark{background:#1e1e1e;color:#f5f5f5;}
body.dark header{background:#16a085;}
body.dark .project{background:#2c2c2c;color:#f5f5f5;}
body.dark .code{background:#333;color:#f5f5f5;}
body.dark .star-btn, body.dark .comment-btn, body.dark .delete-btn, body.dark .expand-btn{opacity:0.85;}
</style>
</header>
<main>
<div id="post-section" style="display:none;">
<h2>Post Your Code</h2>
<input id="title" placeholder="Project Title">
<textarea id="code" rows="6" placeholder="Paste your code here"></textarea>
<button id="postBtn">Post Project</button>
</div>

<div class="profile-section" id="profile-section" style="display:none;">
<h2>Your Profile</h2>
<div id="profileName"></div>
<div id="userProjects"></div>
</div>

<h2>Top 3 Today</h2>
<div id="topProjects"></div>

<h2>All Projects</h2>
<div id="projects"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, arrayUnion, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4haY4VX-vgO03yA6Yj6hvsLw0EZav0Gk",
  authDomain: "orgenahub-7bca3.firebaseapp.com",
  projectId: "orgenahub-7bca3",
  storageBucket: "orgenahub-7bca3.firebasestorage.app",
  messagingSenderId: "807048048445",
  appId: "1:807048048445:web:48a2e965eee533a40e5f54",
  measurementId: "G-ZZRELPEM6J"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// DOM
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const postSection = document.getElementById('post-section');
const titleInput = document.getElementById('title');
const codeInput = document.getElementById('code');
const postBtn = document.getElementById('postBtn');
const projectsContainer = document.getElementById('projects');
const topProjectsContainer = document.getElementById('topProjects');
const profileSection = document.getElementById('profile-section');
const profileName = document.getElementById('profileName');
const userProjects = document.getElementById('userProjects');
let currentUser = null;

// Auth
loginBtn.addEventListener('click', async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    currentUser = result.user;
    updateUI();
    loadProjects();
  } catch(e) { alert("Login failed: "+e.message); }
});
logoutBtn.addEventListener('click', async () => {
  await signOut(auth);
  currentUser = null;
  updateUI();
});
onAuthStateChanged(auth,user=>{
  currentUser=user;
  updateUI();
  if(user) loadProjects();
});
function updateUI(){
  loginBtn.style.display=currentUser?'none':'inline-block';
  logoutBtn.style.display=currentUser?'inline-block':'none';
  postSection.style.display=currentUser?'block':'none';
  profileSection.style.display=currentUser?'block':'none';
  if(currentUser) profileName.innerText="Username: "+currentUser.displayName;
}

// Post project
postBtn.addEventListener('click', async ()=>{
  const title = titleInput.value.trim();
  const code = codeInput.value.trim();
  if(!title||!code)return alert("Fill both fields");
  await addDoc(collection(db,'projects'),{
    title, code, user:currentUser.displayName, stars:[], comments:[], createdAt: serverTimestamp()
  });
  titleInput.value=''; codeInput.value='';
});

// Star/comment/delete
import { getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
window.starProject = async id => {
  if(!currentUser) return alert("Login first");
  const projectRef = doc(db,'projects',id);
  const projectSnap = await getDoc(projectRef);
  const stars = projectSnap.data()?.stars || [];
  if(stars.includes(currentUser.displayName)) return;
  await updateDoc(projectRef, { stars: arrayUnion(currentUser.displayName) });
};
window.addComment = async (id,text)=>{
  if(!currentUser||!text) return;
  const projectRef = doc(db,'projects',id);
  await updateDoc(projectRef,{comments: arrayUnion({user:currentUser.displayName,text})});
};
window.deleteProject = async (id,user)=>{
  if(!currentUser||currentUser.displayName!==user) return alert("Only owner can delete");
  if(!confirm("Delete this project?")) return;
  await deleteDoc(doc(db,'projects',id));
};

// Create project card with preview/expand
function createProjectCard(p,id,isProfile=false){
  const previewLength = 130;
  let codePreview = p.code;
  let isTruncated = false;
  if(p.code.length>previewLength){ codePreview = p.code.slice(0,previewLength)+'...'; isTruncated=true; }
  const div=document.createElement('div'); div.className='project';
  div.innerHTML=`
    <h3>${p.title} by ${p.user}</h3>
    <pre class="code" id="code-${id}">${codePreview}</pre>
    ${isTruncated?`<button class="expand-btn" data-id="${id}">+ Expand</button>`:''}
    <div class="stars">
      <button class="star-btn ${p.stars?.includes(currentUser?.displayName)?'highlight':''}" onclick="starProject('${id}')">‚≠ê ${p.stars?.length||0}</button>
    </div>
    <div class="comments">
      ${p.comments?.map(c=>`<p><b>${c.user}:</b> ${c.text}</p>`).join('')||''}
      ${currentUser?`<input class="comment-input" id="comment-${id}" placeholder="Add comment">
      <button class="comment-btn" onclick="addComment('${id}',document.getElementById('comment-${id}').value)">Comment</button>`:''}
    </div>
    ${currentUser && currentUser.displayName===p.user?`<button class="delete-btn" onclick="deleteProject('${id}','${p.user}')">Delete</button>`:''}
  `;
  // Expand button event
  if(isTruncated){
    const btn=div.querySelector('.expand-btn');
    btn.addEventListener('click',()=>{
      document.getElementById('code-'+id).innerText=p.code;
      btn.style.display='none';
    });
  }
  return div;
}

// Load projects (top + all + profile)
function loadProjects(){
  const q = query(collection(db,'projects'), orderBy('createdAt','desc'));
  onSnapshot(q,snapshot=>{
    projectsContainer.innerHTML=''; userProjects.innerHTML=''; topProjectsContainer.innerHTML='';
    let projectsArr=[];
    snapshot.forEach(docSnap=>{
      const p=docSnap.data(); projectsArr.push({...p,id:docSnap.id});
      // All projects
      const card = createProjectCard(p,docSnap.id);
      projectsContainer.appendChild(card);
      // User profile
      if(currentUser && currentUser.displayName===p.user){
        const userCard=createProjectCard(p,docSnap.id,true);
        userProjects.appendChild(userCard);
      }
    });
    // Top 3 today (by stars count)
    const top3 = projectsArr.sort((a,b)=> (b.stars?.length||0)-(a.stars?.length||0) ).slice(0,3);
    top3.forEach(p=>{
      const topCard=createProjectCard(p,p.id);
      topProjectsContainer.appendChild(topCard);
    });
  });
}
</script>
</body>
</html>
