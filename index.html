<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orgena Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ... keep all your existing styles ... */
</style>
</head>
<body>
<header>
<h1>Orgena Hub</h1>
<nav>
<button id="loginBtn">Login/Register</button>
<button id="logoutBtn" style="display:none;">Logout</button>
<button id="changeUsernameBtn" style="display:none;">Change Username</button>
<button id="darkModeBtn">Toggle Dark Mode</button>
</nav>
</header>
<main>
<div id="post-section" style="display:none;">
<h2>Post Your Code</h2>
<input id="title" placeholder="Project Title">
<textarea id="code" rows="6" placeholder="Paste your code here"></textarea>
<button id="postBtn">Post Project</button>
</div>
<div class="profile-section" id="profile-section" style="display:none;">
<h2>Your Profile</h2>
<div id="profileName"></div>
<div id="userProjects"></div>
</div>
<h2>All Projects</h2>
<div id="projects"></div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = { /* ... your config ... */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const changeUsernameBtn=document.getElementById('changeUsernameBtn');
const postSection=document.getElementById('post-section');
const titleInput=document.getElementById('title');
const codeInput=document.getElementById('code');
const postBtn=document.getElementById('postBtn');
const projectsContainer=document.getElementById('projects');
const profileSection=document.getElementById('profile-section');
const profileName=document.getElementById('profileName');
const userProjects=document.getElementById('userProjects');

let currentUser=null;
let lastPostTime=0;
let lastCommentTime=0;
const defaultAvatar='https://www.gravatar.com/avatar/?d=mp&s=30';

loginBtn.addEventListener('click', async ()=>{
  try { const result=await signInWithPopup(auth,provider); currentUser=result.user; updateUI(); } 
  catch(e){ alert("Login failed: "+e.message); }
});
logoutBtn.addEventListener('click', async ()=>{ await signOut(auth); currentUser=null; updateUI(); });
changeUsernameBtn.addEventListener('click', async ()=>{
  const newName=prompt("Enter new username:", currentUser.displayName);
  if(newName && newName.trim()!==currentUser.displayName){
    await updateProfile(currentUser,{displayName:newName});
    currentUser.displayName=newName; updateUI(); alert("Username updated!");
  }
});
onAuthStateChanged(auth,user=>{ currentUser=user; updateUI(); loadProjects(); });

function updateUI(){
  loginBtn.style.display=currentUser?'none':'inline-block';
  logoutBtn.style.display=currentUser?'inline-block':'none';
  changeUsernameBtn.style.display=currentUser?'inline-block':'none';
  postSection.style.display=currentUser?'block':'none';
  profileSection.style.display=currentUser?'block':'none';
  if(currentUser){
    const avatar=currentUser.photoURL||defaultAvatar;
    profileName.innerHTML=`<img class="profile-pic" src="${avatar}"> ${currentUser.displayName}`;
  }
}

// Post Project
postBtn.addEventListener('click', async ()=>{
  if(!currentUser) return alert("Login first");
  const now=Date.now();
  if(now-lastPostTime<5000) return alert("Wait 5s between posts.");
  const title=titleInput.value.trim(), code=codeInput.value.trim();
  if(!title||!code) return alert("Fill both fields");
  await addDoc(collection(db,'projects'),{ title, code, user:currentUser.displayName, stars:[], comments:[], createdAt:serverTimestamp() });
  lastPostTime=now; titleInput.value=''; codeInput.value='';
});

// Toggle star
window.toggleStar=async(id)=>{
  if(!currentUser) return alert("Login first");
  const ref=doc(db,'projects',id); const snap=await getDoc(ref);
  const stars=snap.data()?.stars||[];
  if(stars.includes(currentUser.displayName)) await updateDoc(ref,{stars:stars.filter(s=>s!==currentUser.displayName)});
  else await updateDoc(ref,{stars:arrayUnion(currentUser.displayName)});
};

// Add Comment
window.addComment=async(id,inputElem)=>{
  if(!currentUser) return alert("Login first");
  const text=inputElem.value.trim(); if(!text) return;
  const now=Date.now(); if(now-lastCommentTime<3000) return alert("Wait 3s between comments.");
  await updateDoc(doc(db,'projects',id),{comments:arrayUnion({user:currentUser.displayName,text,date:serverTimestamp()})});
  lastCommentTime=now; inputElem.value='';
};

// Delete Comment
window.deleteComment=async(projectId,comment)=>{
  if(!currentUser) return;
  const projSnap=await getDoc(doc(db,'projects',projectId));
  if(comment.user!==currentUser.displayName && projSnap.data()?.user!==currentUser.displayName) return alert("Only comment owner or post owner can delete.");
  await updateDoc(doc(db,'projects',projectId),{comments:arrayRemove(comment)});
};

// Edit Comment
window.editComment=async(projectId,comment)=>{
  if(comment.user!==currentUser.displayName) return alert("Only your comment can be edited.");
  const newText=prompt("Edit comment:",comment.text); if(!newText) return;
  await deleteComment(projectId,comment);
  await updateDoc(doc(db,'projects',projectId),{comments:arrayUnion({...comment,text:newText})});
};

// Delete Project
window.deleteProject=async(id,user)=>{
  if(!currentUser||currentUser.displayName!==user) return alert("Only owner can delete");
  if(!confirm("Delete this project?")) return;
  await deleteDoc(doc(db,'projects',id));
};

// Load Projects
function loadProjects(){
  const q=query(collection(db,'projects'),orderBy('createdAt','desc'));
  onSnapshot(q,snapshot=>{
    projectsContainer.innerHTML=''; userProjects.innerHTML='';
    snapshot.forEach(docSnap=>{
      const p=docSnap.data(), div=document.createElement('div'); div.className="project";
      let codePreview=p.code, isTruncated=false;
      if(p.code.length>130){ codePreview=p.code.slice(0,130)+"..."; isTruncated=true; }
      div.innerHTML=`
        <h3>${p.title} by ${p.user}</h3>
        <pre class="code" id="code-${docSnap.id}">${codePreview}</pre>
        ${isTruncated?`<button class="expand-btn" data-id="${docSnap.id}">+ Expand</button>`:''}
        <div class="stars"><button class="star-btn ${p.stars?.includes(currentUser?.displayName)?'highlight':''}" data-id="${docSnap.id}">‚≠ê ${p.stars?.length||0}</button></div>
        <div class="comments" id="comments-${docSnap.id}">
          ${p.comments?.map(c=>`<div class="comment"><p><img src="${defaultAvatar}">${c.user}: ${c.text}</p>
          ${currentUser?`<div class="comment-actions">${c.user===currentUser.displayName||p.user===currentUser.displayName?`<button class="edit-btn" data-id="${docSnap.id}" data-user="${c.user}" data-text="${c.text}">Edit</button><button class="delete-btn" data-id="${docSnap.id}" data-user="${c.user}" data-text="${c.text}">Delete</button>`:''}</div>`:''}</div>`).join('')||''}
          ${currentUser?`<input class="comment-input" placeholder="Add comment" id="comment-input-${docSnap.id}"><button class="comment-btn" data-id="${docSnap.id}">Comment</button>`:''}
        </div>
        ${currentUser&&currentUser.displayName===p.user?`<button class="delete-btn" data-id="${docSnap.id}">Delete Post</button>`:''}
      `;
      projectsContainer.appendChild(div);

      // Profile Section
      if(currentUser&&currentUser.displayName===p.user){
        const ud=document.createElement('div'); ud.className="project";
        ud.innerHTML=`<h4>${p.title}</h4><pre class="code">${p.code}</pre><button class="delete-btn" data-id="${docSnap.id}">Delete Post</button>`;
        userProjects.appendChild(ud);
      }
    });

    // Attach all button events AFTER rendering
    document.querySelectorAll('.expand-btn').forEach(btn=>btn.onclick=()=>{
      const pre=document.getElementById('code-'+btn.dataset.id);
      const fullText=snapshot.docs.find(d=>d.id===btn.dataset.id).data().code;
      pre.innerText=fullText; btn.style.display='none';
    });
    document.querySelectorAll('.star-btn').forEach(btn=>btn.onclick=()=>toggleStar(btn.dataset.id));
    document.querySelectorAll('.comment-btn').forEach(btn=>{
      const inputElem=document.getElementById('comment-input-'+btn.dataset.id);
      btn.onclick=()=>addComment(btn.dataset.id,inputElem);
    });
    document.querySelectorAll('.edit-btn').forEach(btn=>btn.onclick=()=>editComment(btn.dataset.id,{user:btn.dataset.user,text:btn.dataset.text}));
    document.querySelectorAll('.delete-btn').forEach(btn=>{
      if(btn.innerText==="Delete Post") btn.onclick=()=>deleteProject(btn.dataset.id,currentUser.displayName);
      else btn.onclick=()=>deleteComment(btn.dataset.id,{user:btn.dataset.user,text:btn.dataset.text});
    });
  });
}

// Dark Mode
const darkModeBtn=document.getElementById('darkModeBtn');
if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
darkModeBtn.addEventListener('click',()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light');
});
</script>
</body>
</html>
