<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orgena Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Roboto',sans-serif;background:#f5f6fa;color:#333;}
header{background:#1abc9c;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
header h1{font-weight:700;margin-bottom:5px;}
header nav{display:flex;flex-wrap:wrap;gap:5px;}
header nav button{padding:6px 12px;border:none;border-radius:5px;background:#16a085;color:white;font-weight:bold;cursor:pointer;transition:0.3s;}
header nav button:hover{background:#149174;}
main{max-width:1000px;margin:20px auto;padding:0 15px;display:flex;flex-direction:column;gap:20px;}
section{display:flex;flex-direction:column;gap:15px;}
#projects{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;}
.project{background:white;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);padding:15px;display:flex;flex-direction:column;transition:0.3s;position:relative;}
.project:hover{transform:translateY(-3px);}
.project h3{margin-bottom:8px;color:#1abc9c;}
.code{background:#2c3e50;color:#ecf0f1;padding:10px;border-radius:8px;font-family:'Courier New',monospace;white-space:pre-wrap;overflow-x:auto;margin-bottom:8px;}
.stars,.comments{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:5px;}
.star-btn{background:#e67e22;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-weight:bold;transition:0.2s;}
.star-btn.highlight{background:#f1c40f;}
.star-btn:hover{background:#cf711b;}
.comment-input{flex:1;padding:6px;border-radius:5px;border:1px solid #ccc;}
.comment-btn,.expand-btn,.delete-btn,.edit-btn{padding:5px 10px;border:none;border-radius:5px;cursor:pointer;margin-top:5px;}
.comment-btn{background:#2980b9;color:white;}
.comment-btn:hover{background:#1f5f8b;}
.delete-btn{background:#c0392b;color:white;}
.delete-btn:hover{background:#992d22;}
.expand-btn{background:#2980b9;color:white;}
.expand-btn:hover{background:#1f5f8b;}
.edit-btn{background:#f39c12;color:white;}
.edit-btn:hover{background:#d68910;}
.comment-wrapper{position:relative;}
.comment-options{position:absolute;top:0;right:0;display:none;flex-direction:column;}
.comment-wrapper:hover .comment-options{display:flex;}
#post-section, .profile-section{background:white;padding:15px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
input,textarea{width:100%;margin-bottom:10px;padding:8px;border-radius:5px;border:1px solid #ccc;}
button{cursor:pointer;}
@media(max-width:600px){.stars,.comments{flex-direction:column;align-items:stretch;}.comment-btn,.delete-btn,.expand-btn,.edit-btn{width:100%;}}
body.dark{background-color:#1e1e1e;color:#f5f5f5;}
body.dark header{background-color:#16a085;}
body.dark .project{background-color:#2c2c2c;color:#f5f5f5;}
body.dark .code{background-color:#333;color:#f5f5f5;}
body.dark .star-btn,body.dark .comment-btn,body.dark .delete-btn,body.dark .edit-btn{opacity:0.85;}
</style>
</head>
<body>
<header>
<h1>Orgena Hub</h1>
<nav>
<button id="loginBtn">Login/Register</button>
<button id="logoutBtn" style="display:none;">Logout</button>
<button id="changeUsernameBtn" style="display:none;">Change Username</button>
<button id="darkModeBtn">Toggle Dark Mode</button>
</nav>
</header>

<main>
<section id="post-section" style="display:none;">
<h2>Post Your Code</h2>
<input id="title" placeholder="Project Title">
<textarea id="code" rows="6" placeholder="Paste your code here"></textarea>
<button id="postBtn">Post Project</button>
</section>

<section class="profile-section" id="profile-section" style="display:none;">
<h2>Your Profile</h2>
<div id="profileName"></div>
<div id="userProjects"></div>
</section>

<section>
<h2>All Projects</h2>
<div id="projects"></div>
</section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyC4haY4VX-vgO03yA6Yj6hvsLw0EZav0Gk",authDomain:"orgenahub-7bca3.firebaseapp.com",projectId:"orgenahub-7bca3",storageBucket:"orgenahub-7bca3.firebasestorage.app",messagingSenderId:"807048048445",appId:"1:807048048445:web:48a2e965eee533a40e5f54"};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);
const provider=new GoogleAuthProvider();

const loginBtn=document.getElementById('loginBtn');
const logoutBtn=document.getElementById('logoutBtn');
const changeUsernameBtn=document.getElementById('changeUsernameBtn');
const postSection=document.getElementById('post-section');
const titleInput=document.getElementById('title');
const codeInput=document.getElementById('code');
const postBtn=document.getElementById('postBtn');
const projectsContainer=document.getElementById('projects');
const profileSection=document.getElementById('profile-section');
const profileName=document.getElementById('profileName');
const userProjects=document.getElementById('userProjects');

let currentUser=null;
let lastPostTime=0;
let lastCommentTime={};

// Dark mode
const darkModeBtn=document.getElementById('darkModeBtn');
if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
darkModeBtn.addEventListener('click',()=>{document.body.classList.toggle('dark');localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light');});

// Auth
loginBtn.addEventListener('click',async()=>{try{const res=await signInWithPopup(auth,provider);currentUser=res.user;updateUI();loadProjects();}catch(e){alert("Login failed: "+e.message);}});
logoutBtn.addEventListener('click',async()=>{await signOut(auth);currentUser=null;updateUI();});
onAuthStateChanged(auth,user=>{currentUser=user;updateUI();if(user) loadProjects();});

function updateUI(){
  loginBtn.style.display=currentUser?'none':'inline-block';
  logoutBtn.style.display=currentUser?'inline-block':'none';
  postSection.style.display=currentUser?'block':'none';
  profileSection.style.display=currentUser?'block':'none';
  changeUsernameBtn.style.display=currentUser?'inline-block':'none';
  if(currentUser) profileName.innerText="Username: "+currentUser.displayName;
}

// Change username
changeUsernameBtn.addEventListener('click',async()=>{
  const newName=prompt("Enter new username:",currentUser.displayName);
  if(newName && newName!==currentUser.displayName){
    await updateProfile(currentUser,{displayName:newName});
    updateUI();
  }
});

// Post project (limit spam: 10s between posts)
postBtn.addEventListener('click',async()=>{
  if(Date.now()-lastPostTime<10000) return alert("Wait 10 seconds between posts.");
  const title=titleInput.value.trim(); const code=codeInput.value.trim();
  if(title.length<3 || code.length<10) return alert("Title or code too short.");
  await addDoc(collection(db,'projects'),{title,code,user:currentUser.displayName,stars:[],comments:[],createdAt:serverTimestamp()});
  titleInput.value=''; codeInput.value=''; lastPostTime=Date.now();
});

// Helper to create project cards
async function createProjectCard(p,id){
  const card=document.createElement('div'); card.className='project';
  const highlight=p.stars?.includes(currentUser?.displayName)?'highlight':'';
  const previewLength=130; let codePreview=p.code; let isTruncated=false;
  if(p.code.length>previewLength){codePreview=p.code.slice(0,previewLength)+'...'; isTruncated=true;}

  card.innerHTML=`
    <h3>${p.title} by ${p.user}</h3>
    <pre class="code" id="code-${id}">${codePreview}</pre>
    ${isTruncated?`<button class="expand-btn" onclick="document.getElementById('code-${id}').innerText='${p.code.replace(/`/g,'\\`')}'; this.style.display='none';">+ Expand</button>`:''}
    <div class="stars">
      <button class="star-btn ${highlight}" onclick="toggleStar('${id}')">‚≠ê ${p.stars?.length||0}</button>
    </div>
    <div class="comments" id="comments-${id}">
      ${p.comments?.map(c=>commentHTML(c,p.user,id)).join('')||''}
    </div>
    ${currentUser && currentUser.displayName===p.user?`<button class="delete-btn" onclick="deleteProject('${id}')">Delete Post</button>`:''}
  `;
  return card;
}

// Comment HTML
function commentHTML(c,ownerId,projectId){
  let options='';
  if(currentUser && (currentUser.displayName===c.user || currentUser.displayName===ownerId)){
    options=`<div class="comment-options">
      <button class="edit-btn" onclick="editComment('${projectId}','${c.id}','${c.text.replace(/`/g,'\\`')}')">Edit</button>
      <button class="delete-btn" onclick="deleteComment('${projectId}','${c.id}')">Delete</button>
    </div>`;
  }
  return `<div class="comment-wrapper" id="comment-${c.id}"><b>${c.user}:</b> ${c.text} ${options}</div>`;
}

// Toggle star
window.toggleStar=async(id)=>{
  const docRef=doc(db,'projects',id); const snap=await getDoc(docRef);
  const stars=snap.data().stars||[];
  if(stars.includes(currentUser.displayName)) await updateDoc(docRef,{stars:arrayRemove(currentUser.displayName)});
  else await updateDoc(docRef,{stars:arrayUnion(currentUser.displayName)});
};

// Edit/Delete comment functions
window.editComment=async(projectId,commentId,text)=>{
  const newText=prompt("Edit comment:",text); if(!newText) return;
  const docRef=doc(db,'projects',projectId);
  const snap=await getDoc(docRef);
  const comments=snap.data().comments.map(c=>c.id===commentId?{...c,text:newText}:c);
  await updateDoc(docRef,{comments});
};
window.deleteComment=async(projectId,commentId)=>{
  const docRef=doc(db,'projects',projectId);
  const snap=await getDoc(docRef);
  const comments=snap.data().comments.filter(c=>c.id!==commentId);
  await updateDoc(docRef,{comments});
};

// Delete post
window.deleteProject=async(id)=>{if(!confirm("Delete this post?")) return; await deleteDoc(doc(db,'projects',id));};

// Load projects
async function loadProjects(){
  const q=query(collection(db,'projects'),orderBy('createdAt','desc'));
  onSnapshot(q,snap=>{
    projectsContainer.innerHTML=''; userProjects.innerHTML='';
    snap.forEach(async docSnap=>{
      const p=docSnap.data(); p.id=docSnap.id;
      // Add comment IDs if missing
      p.comments=p.comments.map((c,i)=>({...c,id:c.id||('c'+i)}));
      const card=await createProjectCard(p,docSnap.id);
      projectsContainer.appendChild(card);
      // Add to profile section if owner
      if(currentUser && currentUser.displayName===p.user){
        const up=document.createElement('div'); up.className='project';
        up.innerHTML=`<h4>${p.title}</h4><pre class="code">${p.code}</pre><button class="delete-btn" onclick="deleteProject('${docSnap.id}')">Delete Post</button>`;
        userProjects.appendChild(up);
      }
    });
  });
}
</script>
</body>
</html>
